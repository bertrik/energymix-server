<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="refresh" content="300">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NL Elektriciteit</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div style="width: 750px; margin-left: auto; margin-right: auto">
    <canvas id="chart"></canvas>
</div>
<div style="width: 100pct">
    <canvas id="priceChart" height="50px"></canvas>
</div>

<script>
    // Fetch data from the API
    fetch('https://stofradar.nl/electricity/generation' + location.search)
        .then(response => response.json())
        .then(data => {
            // Process the mix data
            const labels = data.mix.map(item => item.id); // Extract energy source names
            const values = data.mix.map(item => item.power); // Extract power values
            const colors = data.mix.map(item => item.color + "CC"); // Extract colors

            // Create the pie chart
            const ctx = document.getElementById('chart').getContext('2d');
            new Chart(ctx, {
                type: 'pie', // Pie chart type
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Actuele Nederlandse elektriciteitsopwek (MW)',
                        data: values,
                        backgroundColor: colors, // Custom colors for each segment
                        borderRadius: 10,
                        hoverOffset: 20,
                    }],
                },
                options: {
                    layout: {
                        padding: 10
                    },
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Actuele Nederlandse elektriciteitsopwek',
                            font: { size: 18 }
                        },
                        subtitle: {
                            display: true,
                            text: `Source: ENTSO-E (${data.datetime})`
                        },
                        legend: {
                            align: 'start',
                            position: 'chartArea',
                        },
                        tooltip: {
                            callbacks: {
                                label: function (tooltipItem) {
                                    const value = tooltipItem.raw; // Current value
                                    const percentage = ((value / data.total) * 100).toFixed(1);
                                    return `${value} MW (${percentage}%)`;
                                }
                            },
                        }
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error fetching data:', error);
        });
</script>

<script>
    async function drawPriceChart() {
      const r = await fetch('https://stofradar.nl/electricity/price');
      const d = await r.json();

      const series = d['day-ahead'];
      const values = series.map(p => p.price / 1000); // €/kWh
      const times = series.map(p => new Date(p.datetime));

      // thresholds at 20% and 80%
      const sorted = [...values].sort((a, b) => a - b);
      const tLow  = sorted[Math.floor(sorted.length * 0.20)];
      const tHigh = sorted[Math.floor(sorted.length * 0.80)];

      const labels = times.map(t =>
        t.toLocaleTimeString('nl-NL', { hour: '2-digit', minute: '2-digit' })
      );

      const barColors = values.map(v => {
        if (v <= tLow)  return 'green';
        if (v >= tHigh) return 'red';
        return 'yellow';
      });

      // derive current quarter-hour time from JSON
      const nowJson = new Date(d.current.datetime);

      // floor to 15-minute bucket
      const roundedMinutes = Math.floor(nowJson.getMinutes() / 15) * 15;

      const currentIndex = times.findIndex(t =>
        t.getHours() === nowJson.getHours() &&
        t.getMinutes() === roundedMinutes
      );

      // convert current price to €/kWh for display
      const priceNow = (d.current.price / 1000).toFixed(5);
      const timeNow = nowJson.toLocaleTimeString('nl-NL', { hour: '2-digit', minute: '2-digit' });

      const chart = new Chart(document.getElementById('priceChart'), {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            data: values,
            backgroundColor: barColors,
            borderWidth: values.map((_, i) => i === currentIndex ? 4 : 1),
            borderColor: values.map((_, i) => i === currentIndex ? 'blue' : 'rgba(100,100,100,0.3)'),
          }]
        },
        options: {
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: c => `€ ${c.raw.toFixed(5)} / kWh`
              }
            }
          },
          scales: {
            x: { title: { display: true, text: 'Time' } },
            y: { title: { display: true, text: 'Price (€ / kWh)' } }
          }
        }
      });
    }

    drawPriceChart();
</script>

</body>
</html>

